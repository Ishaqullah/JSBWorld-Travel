// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  CUSTOMER
  ADMIN
  GUIDE
}

enum TourDifficulty {
  EASY
  MODERATE
  CHALLENGING
}

enum TourStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  AWAITING_VERIFICATION
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  PAYPAL
  BANK_TRANSFER
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum InclusionType {
  INCLUDED
  EXCLUDED
}

enum TourDateStatus {
  AVAILABLE
  FULL
  CANCELLED
}

enum NotificationType {
  BOOKING
  PAYMENT
  REVIEW
  SYSTEM
}

enum ContactMessageStatus {
  NEW
  RESPONDED
  CLOSED
}

// Models

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  passwordHash          String    @map("password_hash")
  name                  String
  avatarUrl             String?   @map("avatar_url")
  phone                 String?
  role                  UserRole  @default(CUSTOMER)
  isVerified            Boolean   @default(false) @map("is_verified")
  verificationToken     String?   @map("verification_token")
  resetPasswordToken    String?   @map("reset_password_token")
  resetPasswordExpires  DateTime? @map("reset_password_expires")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  // Relations
  createdTours      Tour[]
  bookings          Booking[]
  payments          Payment[]
  reviews           Review[]
  wishlists         Wishlist[]
  notifications     Notification[]
  contactMessages   ContactMessage[]

  @@map("users")
}

model Category {
  id            String   @id @default(cuid())
  name          String   @unique
  slug          String   @unique
  icon          String
  description   String?
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  tours Tour[]

  @@map("categories")
}

model Tour {
  id              String         @id @default(cuid())
  title           String
  slug            String         @unique
  categoryId      String         @map("category_id")
  location        String
  price           Decimal        @db.Decimal(10, 2)
  duration        Int
  rating          Decimal        @default(0) @db.Decimal(3, 2)
  reviewCount     Int            @default(0) @map("review_count")
  maxGroupSize    Int            @map("max_group_size")
  difficulty      TourDifficulty
  featuredImage   String         @map("featured_image")
  description     String         @db.Text
  depositFee      Decimal?       @db.Decimal(10, 2) @map("deposit_fee")
  status          TourStatus     @default(DRAFT)
  createdById     String         @map("created_by")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  deletedAt       DateTime?      @map("deleted_at")

  // Relations
  category        Category           @relation(fields: [categoryId], references: [id])
  createdBy       User               @relation(fields: [createdById], references: [id])
  images          TourImage[]
  highlights      TourHighlight[]
  inclusions      TourInclusion[]
  itinerary       TourItinerary[]
  dates           TourDate[]
  bookings        Booking[]
  reviews         Review[]
  wishlists       Wishlist[]
  addOns          TourAddOn[]

  @@map("tours")
}

model TourImage {
  id           String   @id @default(cuid())
  tourId       String   @map("tour_id")
  imageUrl     String   @map("image_url")
  altText      String?  @map("alt_text")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@map("tour_images")
}

model TourHighlight {
  id           String @id @default(cuid())
  tourId       String @map("tour_id")
  highlight    String
  displayOrder Int    @default(0) @map("display_order")

  // Relations
  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@map("tour_highlights")
}

model TourInclusion {
  id           String        @id @default(cuid())
  tourId       String        @map("tour_id")
  item         String
  type         InclusionType
  displayOrder Int           @default(0) @map("display_order")

  // Relations
  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@map("tour_inclusions")
}

model TourItinerary {
  id           String  @id @default(cuid())
  tourId       String  @map("tour_id")
  dayNumber    Int     @map("day_number")
  title        String
  description  String  @db.Text
  imageUrl     String? @map("image_url")
  displayOrder Int     @default(0) @map("display_order")

  // Relations
  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@map("tour_itinerary")
}

model TourDate {
  id                      String          @id @default(cuid())
  tourId                  String          @map("tour_id")
  startDate               DateTime        @map("start_date") @db.Date
  endDate                 DateTime        @map("end_date") @db.Date
  availableSlots          Int             @map("available_slots")
  bookedSlots             Int             @default(0) @map("booked_slots")
  status                  TourDateStatus  @default(AVAILABLE)
  
  // Pricing fields - all in USD
  priceWithoutFlight      Decimal         @db.Decimal(10, 2) @map("price_without_flight")
  priceWithFlight         Decimal         @db.Decimal(10, 2) @map("price_with_flight")
  earlyBirdPriceWithout   Decimal?        @db.Decimal(10, 2) @map("early_bird_price_without")
  earlyBirdPriceWith      Decimal?        @db.Decimal(10, 2) @map("early_bird_price_with")
  earlyBirdDeadline       DateTime?       @map("early_bird_deadline") @db.Date
  childPriceWithout       Decimal         @db.Decimal(10, 2) @map("child_price_without")
  childPriceWithFlight    Decimal         @db.Decimal(10, 2) @map("child_price_with_flight")
  singleSupplement        Decimal         @default(0) @db.Decimal(10, 2) @map("single_supplement")
  
  createdAt               DateTime        @default(now()) @map("created_at")
  updatedAt               DateTime        @updatedAt @map("updated_at")

  // Relations
  tour     Tour      @relation(fields: [tourId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@map("tour_dates")
}

model Booking {
  id                 String        @id @default(cuid())
  bookingNumber      String        @unique @map("booking_number")
  userId             String        @map("user_id")
  tourId             String        @map("tour_id")
  tourDateId         String        @map("tour_date_id")
  numberOfTravelers  Int           @map("number_of_travelers")
  adultsCount        Int           @default(1) @map("adults_count")
  childrenCount      Int           @default(0) @map("children_count")
  infantsCount       Int           @default(0) @map("infants_count")
  flightOption       String        @default("without") @map("flight_option")
  totalPrice         Decimal       @db.Decimal(10, 2) @map("total_price")
  isDepositPayment   Boolean       @default(false) @map("is_deposit_payment")
  depositAmount      Decimal?      @db.Decimal(10, 2) @map("deposit_amount")
  remainingBalance   Decimal?      @db.Decimal(10, 2) @map("remaining_balance")
  addOnsTotal        Decimal?      @db.Decimal(10, 2) @map("add_ons_total")
  bookingDate        DateTime      @default(now()) @map("booking_date")
  status             BookingStatus @default(PENDING)
  specialRequests    String?       @db.Text @map("special_requests")
  cancelledAt        DateTime?     @map("cancelled_at")
  cancellationReason String?       @db.Text @map("cancellation_reason")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Relations
  user      User              @relation(fields: [userId], references: [id])
  tour      Tour              @relation(fields: [tourId], references: [id])
  tourDate  TourDate          @relation(fields: [tourDateId], references: [id])
  travelers BookingTraveler[]
  payment   Payment?
  review    Review?
  addOns    BookingAddOn[]

  @@map("bookings")
}

model BookingTraveler {
  id                  String    @id @default(cuid())
  bookingId           String    @map("booking_id")
  travelerType        String    @default("adult") @map("traveler_type")
  fullName            String    @map("full_name")
  dateOfBirth         DateTime? @map("date_of_birth") @db.Date
  age                 Int?
  gender              String?
  nationality         String?
  passportNumber      String?   @map("passport_number")
  passportExpiry      DateTime? @map("passport_expiry") @db.Date
  email               String?
  phone               String?
  dietaryRequirements String?   @map("dietary_requirements")
  createdAt           DateTime  @default(now()) @map("created_at")

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_travelers")
}

model Payment {
  id                    String        @id @default(cuid())
  paymentNumber         String        @unique @map("payment_number")
  bookingId             String        @unique @map("booking_id")
  userId                String        @map("user_id")
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("USD")
  paymentMethod         PaymentMethod @map("payment_method")
  paymentStatus         PaymentStatus @default(PENDING) @map("payment_status")
  stripePaymentIntentId String?       @map("stripe_payment_intent_id")
  stripeChargeId        String?       @map("stripe_charge_id")
  transactionId         String?       @map("transaction_id")
  paidAt                DateTime?     @map("paid_at")
  refundedAt            DateTime?     @map("refunded_at")
  refundAmount          Decimal?      @db.Decimal(10, 2) @map("refund_amount")
  metadata              Json?
  receiptData           String?       @db.LongText @map("receipt_data")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@map("payments")
}

model Review {
  id           String       @id @default(cuid())
  tourId       String       @map("tour_id")
  userId       String       @map("user_id")
  bookingId    String?      @unique @map("booking_id")
  rating       Int
  title        String?
  comment      String       @db.Text
  isVerified   Boolean      @default(false) @map("is_verified")
  status       ReviewStatus @default(PENDING)
  helpfulCount Int          @default(0) @map("helpful_count")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  tour    Tour          @relation(fields: [tourId], references: [id])
  user    User          @relation(fields: [userId], references: [id])
  booking Booking?      @relation(fields: [bookingId], references: [id])
  images  ReviewImage[]

  @@map("reviews")
}

model ReviewImage {
  id        String   @id @default(cuid())
  reviewId  String   @map("review_id")
  imageUrl  String   @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_images")
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tourId    String   @map("tour_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])
  tour Tour @relation(fields: [tourId], references: [id])

  @@unique([userId, tourId])
  @@map("wishlists")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")
  readAt    DateTime?        @map("read_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model ContactMessage {
  id        String               @id @default(cuid())
  userId    String?              @map("user_id")
  name      String
  email     String
  subject   String
  message   String               @db.Text
  status    ContactMessageStatus @default(NEW)
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("contact_messages")
}

// Tour Add-ons - optional extras users can add to their booking
model TourAddOn {
  id           String   @id @default(cuid())
  tourId       String   @map("tour_id")
  name         String
  description  String?  @db.Text
  price        Decimal  @db.Decimal(10, 2)
  imageUrl     String?  @map("image_url")
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  tour         Tour           @relation(fields: [tourId], references: [id], onDelete: Cascade)
  bookingAddOns BookingAddOn[]

  @@map("tour_add_ons")
}

// Booking Add-ons - tracks which add-ons were selected for a booking
model BookingAddOn {
  id        String   @id @default(cuid())
  bookingId String   @map("booking_id")
  addOnId   String   @map("add_on_id")
  quantity  Int      @default(1)
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  booking Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  addOn   TourAddOn @relation(fields: [addOnId], references: [id])

  @@map("booking_add_ons")
}

// Custom Itinerary - custom tour requests from users
model CustomItinerary {
  id                String   @id @default(cuid())
  customerName      String   @map("customer_name")
  customerEmail     String   @map("customer_email")
  customerPhone     String?  @map("customer_phone")
  departureCity     String?  @map("departure_city")
  destination       String
  travelDates       String   @map("travel_dates")
  totalDays         Int      @default(1) @map("total_days")
  adultsCount       Int      @default(1) @map("adults_count")
  childrenCount     Int      @default(0) @map("children_count")
  infantsCount      Int      @default(0) @map("infants_count")
  tourType          String?  @map("tour_type")
  details           String?  @db.Text
  status            String   @default("PENDING")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("custom_itineraries")
}

// Pending Email Verification - temporary storage for signup verification
model PendingVerification {
  id                String   @id @default(cuid())
  email             String   @unique
  verificationCode  String   @map("verification_code")
  name              String
  passwordHash      String   @map("password_hash")
  expiresAt         DateTime @map("expires_at")
  createdAt         DateTime @default(now()) @map("created_at")

  @@map("pending_verifications")
}

// Password Reset OTP - temporary storage for forgot password OTP
model PasswordResetOTP {
  id        String   @id @default(cuid())
  email     String   @unique
  otpCode   String   @map("otp_code")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_otps")
}

