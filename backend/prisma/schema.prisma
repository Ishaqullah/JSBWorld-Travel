// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  CUSTOMER
  ADMIN
  GUIDE
}

enum TourDifficulty {
  EASY
  MODERATE
  CHALLENGING
}

enum TourStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  PAYPAL
  BANK_TRANSFER
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum InclusionType {
  INCLUDED
  EXCLUDED
}

enum TourDateStatus {
  AVAILABLE
  FULL
  CANCELLED
}

enum NotificationType {
  BOOKING
  PAYMENT
  REVIEW
  SYSTEM
}

enum ContactMessageStatus {
  NEW
  RESPONDED
  CLOSED
}

// Models

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  passwordHash          String    @map("password_hash")
  name                  String
  avatarUrl             String?   @map("avatar_url")
  phone                 String?
  role                  UserRole  @default(CUSTOMER)
  isVerified            Boolean   @default(false) @map("is_verified")
  verificationToken     String?   @map("verification_token")
  resetPasswordToken    String?   @map("reset_password_token")
  resetPasswordExpires  DateTime? @map("reset_password_expires")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  // Relations
  createdTours      Tour[]
  bookings          Booking[]
  payments          Payment[]
  reviews           Review[]
  wishlists         Wishlist[]
  notifications     Notification[]
  contactMessages   ContactMessage[]

  @@map("users")
}

model Category {
  id            String   @id @default(uuid())
  name          String   @unique
  slug          String   @unique
  icon          String
  description   String?
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  tours Tour[]

  @@map("categories")
}

model Tour {
  id              String         @id @default(uuid())
  title           String
  slug            String         @unique
  categoryId      String         @map("category_id")
  location        String
  price           Decimal        @db.Decimal(10, 2)
  duration        Int
  rating          Decimal        @default(0) @db.Decimal(3, 2)
  reviewCount     Int            @default(0) @map("review_count")
  maxGroupSize    Int            @map("max_group_size")
  difficulty      TourDifficulty
  featuredImage   String         @map("featured_image")
  description     String         @db.Text
  status          TourStatus     @default(DRAFT)
  createdById     String         @map("created_by")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  deletedAt       DateTime?      @map("deleted_at")

  // Relations
  category        Category           @relation(fields: [categoryId], references: [id])
  createdBy       User               @relation(fields: [createdById], references: [id])
  images          TourImage[]
  highlights      TourHighlight[]
  inclusions      TourInclusion[]
  itinerary       TourItinerary[]
  dates           TourDate[]
  bookings        Booking[]
  reviews         Review[]
  wishlists       Wishlist[]

  @@map("tours")
}

model TourImage {
  id           String   @id @default(uuid())
  tourId       String   @map("tour_id")
  imageUrl     String   @map("image_url")
  altText      String?  @map("alt_text")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@map("tour_images")
}

model TourHighlight {
  id           String @id @default(uuid())
  tourId       String @map("tour_id")
  highlight    String
  displayOrder Int    @default(0) @map("display_order")

  // Relations
  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@map("tour_highlights")
}

model TourInclusion {
  id           String        @id @default(uuid())
  tourId       String        @map("tour_id")
  item         String
  type         InclusionType
  displayOrder Int           @default(0) @map("display_order")

  // Relations
  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@map("tour_inclusions")
}

model TourItinerary {
  id           String @id @default(uuid())
  tourId       String @map("tour_id")
  dayNumber    Int    @map("day_number")
  title        String
  description  String @db.Text
  displayOrder Int    @default(0) @map("display_order")

  // Relations
  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@map("tour_itinerary")
}

model TourDate {
  id             String          @id @default(uuid())
  tourId         String          @map("tour_id")
  startDate      DateTime        @map("start_date") @db.Date
  endDate        DateTime        @map("end_date") @db.Date
  availableSlots Int             @map("available_slots")
  bookedSlots    Int             @default(0) @map("booked_slots")
  status         TourDateStatus  @default(AVAILABLE)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  // Relations
  tour     Tour      @relation(fields: [tourId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@map("tour_dates")
}

model Booking {
  id                 String        @id @default(uuid())
  bookingNumber      String        @unique @map("booking_number")
  userId             String        @map("user_id")
  tourId             String        @map("tour_id")
  tourDateId         String        @map("tour_date_id")
  numberOfTravelers  Int           @map("number_of_travelers")
  totalPrice         Decimal       @db.Decimal(10, 2) @map("total_price")
  bookingDate        DateTime      @default(now()) @map("booking_date")
  status             BookingStatus @default(PENDING)
  specialRequests    String?       @db.Text @map("special_requests")
  cancelledAt        DateTime?     @map("cancelled_at")
  cancellationReason String?       @db.Text @map("cancellation_reason")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Relations
  user      User              @relation(fields: [userId], references: [id])
  tour      Tour              @relation(fields: [tourId], references: [id])
  tourDate  TourDate          @relation(fields: [tourDateId], references: [id])
  travelers BookingTraveler[]
  payment   Payment?
  review    Review?

  @@map("bookings")
}

model BookingTraveler {
  id                  String   @id @default(uuid())
  bookingId           String   @map("booking_id")
  fullName            String   @map("full_name")
  age                 Int
  gender              String?
  passportNumber      String?  @map("passport_number")
  dietaryRequirements String?  @map("dietary_requirements")
  createdAt           DateTime @default(now()) @map("created_at")

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_travelers")
}

model Payment {
  id                    String        @id @default(uuid())
  paymentNumber         String        @unique @map("payment_number")
  bookingId             String        @unique @map("booking_id")
  userId                String        @map("user_id")
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("USD")
  paymentMethod         PaymentMethod @map("payment_method")
  paymentStatus         PaymentStatus @default(PENDING) @map("payment_status")
  stripePaymentIntentId String?       @map("stripe_payment_intent_id")
  stripeChargeId        String?       @map("stripe_charge_id")
  transactionId         String?       @map("transaction_id")
  paidAt                DateTime?     @map("paid_at")
  refundedAt            DateTime?     @map("refunded_at")
  refundAmount          Decimal?      @db.Decimal(10, 2) @map("refund_amount")
  metadata              Json?
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@map("payments")
}

model Review {
  id           String       @id @default(uuid())
  tourId       String       @map("tour_id")
  userId       String       @map("user_id")
  bookingId    String?      @unique @map("booking_id")
  rating       Int
  title        String?
  comment      String       @db.Text
  isVerified   Boolean      @default(false) @map("is_verified")
  status       ReviewStatus @default(PENDING)
  helpfulCount Int          @default(0) @map("helpful_count")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  tour    Tour          @relation(fields: [tourId], references: [id])
  user    User          @relation(fields: [userId], references: [id])
  booking Booking?      @relation(fields: [bookingId], references: [id])
  images  ReviewImage[]

  @@map("reviews")
}

model ReviewImage {
  id        String   @id @default(uuid())
  reviewId  String   @map("review_id")
  imageUrl  String   @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_images")
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tourId    String   @map("tour_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])
  tour Tour @relation(fields: [tourId], references: [id])

  @@unique([userId, tourId])
  @@map("wishlists")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")
  readAt    DateTime?        @map("read_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model ContactMessage {
  id        String               @id @default(uuid())
  userId    String?              @map("user_id")
  name      String
  email     String
  subject   String
  message   String               @db.Text
  status    ContactMessageStatus @default(NEW)
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("contact_messages")
}
